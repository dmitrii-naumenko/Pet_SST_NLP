# Design Doc

Рассказ о том, что. такое Design Doc и как его заполнять тут 

[Telegram](https://t.me/c/1833996782/303)

# ****1. Цели и предпосылки****

## ****1.1. Зачем идем в разработку продукта?****

Бизнес-цель  - ранее выявление инцидентов в транспорте. Для реализации предлагается использовать звук переговоро. 

Почему станет лучше, чем сейчас, от использования ML. Сейчас анализ ведется выборочно и с задержкой, выявление происходит вручную. Создание автоматического сервиса увеличит качество и уменьшит задержку выявления инцидента. Технологии машинного обучения должны увеличить точность по сравнению с простыми алгоритмами поиска ключевых слов. 

Стоимость проекта будет складываться из затрат времени разработчиков (кстати, было бы хорошо записывать время, чтобы понимать сколько времени в часах займется схожая задача) и затрат на тренировку (облачная инфраструктура или закупка сервера)

## 1.2. Бизнес-требования и ограничения

**Бизнес-требования**. На вход переговоры, на выход оповещение и возникновении возможных инцидентов. 

**Бизнес-ограничения**. Качество звукового канала может быть низким. Обработка должна быть в реальном времени, допускается задержка в несколько секунд. 

Описание **бизнес-процесса пилота**, как именно мы будем использовать модель в существующем бизнес-процессе. На аудиопоток подключаем сервис, результат вызывает веб метод и сохраняется в лог. 

**Критерий успешности пилота**. Количество выявленных инцидентов выше ручной проверки при условии контроля уровня ложноположительных ошибок

Возможные **пути развития** проекта. Добавление анализа интонации. Веление архива записей. Аналитика с возможностью получить записи потенциальных инцидентов по анализу содержания и интонации. 

*В рамках **пет-проекта** может быть подготовлено упрощенное решение с использованием открытых доступных данных, схожих по содержимому.*

## ****1.3. Что входит в скоуп проекта/итерации, что не входит****

Что не будет закрыто. Механизм очистки от шумов. Интонационный анализ. Идентификация по голосу. Аппаратные средства. 

В рамках проекта можем использовать выявление инцидентов на других доступных данных, аналогично со звуковыми данными. Сборка в единый сервис для пет-проекта желательно, но не обязательно - достаточно решения *Proof of concept*.

Описание результата с точки зрения качества кода и воспроизводимости решения. Оформление в виде сервиса в докер-контейнере (в рамках пет-проекта допускается воспроизводитмость в локальном окружении)

Описание планируемого технического долга. Решение не будет подготовлено как продукционное: нет мер обеспечения информационной безопасности, масштабирования, отказоустойчивости, мониторинга.

## ****1.4. Предпосылки решения****

Данные: Для реальной задачи исторические данные предоставляет заказчик. В пет-проекте будем использовать открытый датасет для сравнения алгоритмов.

Горизонт прогноза: Реальное время.

Гранулярность модели: конечная задача - работать с потоковыми данными. К конкретной реализации примем допущение, что обрабатываем короткие отрезки длительностью до минуты. Мы можем формировать через 1-5сек новый аудиоотрезок длительностью одну минуту.

Как будет встроена в текущую систему: для продукционного решения планируется выделение отдельного сервера для нескольких потоков обработки, для пет-проекта интеграция не предусмотрена.

Работа с ошибками: Добавление кейсов в датасет для дообучения и валидации.

## ****1.5. Бизнес-метрики**

Стремимся выразить в деньгах или ином целевом показателе качество работы системы.

Бизнес метрика**,** характеризующая потери, связанные со временем обнаружения инцидентов и затратами отработки ложных регистраций:

$$
C=N_{TP} * c * T_{avg} + N_{FP}*c_{FN}
$$

N_tp - количество фактических выявленных инцидентов за период

с, руб/час - средняя стоимость убытков, связанных с увеличением времени обнаружения инцидента на один час

T_avg, ч - среднее время обнаружения инцидентов

N_fp - количество ложно обнаруженных инцидентов

c_fn, руб - стоимость отработки ложнообнаруженного инцидента

В контексте задачи мы можем влиять на T_avg и N_fp

$$
T_{avg}=\frac{N_1}{N}T_1+\frac{N_2}{N}T_2+\frac{N_3}{N}T_3+\frac{N_4}{N}T_4
$$

N_i - количество инцидентов i-ой категории

T_i - среднее время обнаружения инцидентов i-ой категории

Категории инцидентов по характеру обнаружения:

1. Обнаружен только по последствиями, без раннего обнаружения
2. Сообщен сотрудниками самостоятельно
3. Выявлен при частичной проверке переговоров оператором
4. Выявлен автоматически новой системой

В свою очередь, количество инцидентов так же складывается из количества в каждой группе:

$$
N=N_1+N_2+N_3+N_4
$$

$$
N_{TP}=N_{TP1}+N_{TP2}+N_{TP3}+N_{TP4}
$$

$$
N_{FP}=N_{FP1}+N_{FP2}+N_{FP3}+N_{FP4}
$$

# ****2. Методология****

## ****2.1. Постановка задачи****

Бинарная классификация с дисбалансом классов

## ****2.2. Блок-схема решения****

Нет

## ****2.3. Этапы решения задачи****

### ****2.3.1 Выбор метрик****

**Оффлайн-метрики.** 

Набираем статистику по инцидентам. Информация о правильности детекции инцидента отложенной во времени. Метрики так же отложенные, поэтому относятся к офлайн.

TP и FN можем определить, исходя их того предположения, что все инциденты тем или иным образом выявляются, например спустя некоторое время.

FP можем определить по результату отработки заявок на инциденты

Таким образом, рабочая метрика и мерка машинного обучения **Recall@Precision=99,5%**.  Такой метрикой мы фиксируем, что не более 0.5% зафиксированных инцидентов могут оказаться ложноопределенными и увеличиваем долю инцидентов, выявленных системой на раннем этапе.

Для моделей обработки голоса используем метрики на основе **BLEU**

**Онлайн-метрики**

Онлайн метрикой может быть офлайн метрика, определенная на более коротком промежутку времени, например день. Специфичных онлайн метрик не можем иметь в виду задержки обработки данных. Заметим, что метрика будет актуальной только через время, значительно превышающее T_avg после начала эксперимента. 

**Технические метрики:** 

Время обработки запроса, количество одновременных потоков обработки.

### ****2.3.2 Определение объекта и таргета****

Объект - звуковой фрагмент

Таргет - размеченная метка инцидента

### ****2.3.3 Сбор данных****

Для пет проекта:

- берем датасет твиттов с признаком аварии из соревнования на Kaggle
- переводим датасет на русский язык с помощью Yandex Translate API
- используя модели Yandex SpeechKit создаем звуковые записи для каждой строки
- на выходе мы имеем звуковые файлы, промежуточный текст и метку инцидента.

### ****2.3.4 Подготовка данных****

Звуковые данные может потребоваться конвертировать в другой формат.

### ****2.3.5 Работа с  признаками****

- Для задачи STT нужна нормализация записи (выравнивание по громкости, фильтрация шумов)
- Для задачи NLP токенизация и/или леммантизация.

### ****2.3.6 Подготовка тренировочного и тестового наборов данных****

- разделяем датасет в соотношении 60/20/20 на трайн/валид/тест
- для модели Speech-to-text случайно выбираем и фиксируем из каждой части до 1000 строк с целью более быстрой проверки

### ****2.3.7 Схема валидации****

Валидируем модель на отдельной выборке. Кросс-валидацию не используем по причине маленького пет-проекта и экономии времени.

### ****2.3.7 От baseline к полноценной модели****

- рассматриваем несколько обученных SST моделей. Референсное значение берем из текстовых данных, а так же
- рассматриваем модели от мешка слов до Fine tuned BERT

### ****2.3.8 Анализ ошибок****

В продукционном решении проверяем ошибки вручную, проводим кластеризацию, добавляем к дообучающий датасет.

# ****3. Подготовка пилота и внедрения****

## ****3.1. Архитектура решения****

Нет (в пет-проекте)

## ****3.2. Способ оценки пилота****

Нет (в пет-проекте)

## ****3.3. Что считаем успешным пилотом****

Нет (в пет-проекте)

## ****3.4. Описание инфраструктуры и масштабируемости****

Нет (в пет-проекте)

## ****3.5. Мониторинг****

Нет (в пет-проекте)

## ****3.6. Требования к работе системы****

Нет (в пет-проекте)

## ****3.7. Безопасность системы****

Нет (в пет-проекте)

## ****3.8. Безопасность данных****

Нет (в пет-проекте)

## ****3.9. Издержки****

Нет (в пет-проекте)

## ****3.10. Риски****

Возможность появления большого количества ложноопределенных инцидентов и перегрузка службы управления инцидентами.


# ****4. Полезные ссылки****

- [Речевые технологии для русского языка](https://github.com/alphacep/awesome-russian-speech#речевые-технологии-для-русского-языка)